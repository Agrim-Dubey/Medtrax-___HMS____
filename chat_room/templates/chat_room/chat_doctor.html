<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Doctor Chat Room</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f6f6f6; padding: 20px; }
    #chat-box { border: 1px solid #ccc; background: white; height: 400px; overflow-y: auto; padding: 10px; margin-bottom: 10px; }
    .message { margin-bottom: 8px; padding: 6px 8px; border-radius: 8px; }
    .me { background: #d1f7c4; text-align: right; }
    .other { background: #f1f1f1; text-align: left; }
    #messageInput { width: 75%; padding: 8px; }
    #sendBtn { padding: 8px 12px; }
    #tokenInput { width: 80%; padding: 8px; margin-bottom: 10px; }
  </style>
</head>
<body>
  <h2>üë®‚Äç‚öïÔ∏è Doctor Chat Test</h2>

  <p>Paste your <b>JWT Access Token</b> below (from Swagger login response):</p>
  <input id="tokenInput" placeholder="Paste access token here..." />
  <button id="connectBtn">Connect</button>

  <div id="chat-box"></div>
  <input type="text" id="messageInput" placeholder="Type your message..." autocomplete="off" />
  <button id="sendBtn">Send</button>

  <script>
    const roomId = "{{ room_id }}";
    const chatBox = document.getElementById("chat-box");
    const input = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const tokenInput = document.getElementById("tokenInput");
    const connectBtn = document.getElementById("connectBtn");
    let socket = null;
    let currentUserId = null;

    function appendMessage(name, content, isMe) {
      const msg = document.createElement("div");
      msg.className = "message " + (isMe ? "me" : "other");
      msg.textContent = `${name}: ${content}`;
      chatBox.appendChild(msg);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    connectBtn.onclick = () => {
      const token = tokenInput.value.trim();
      if (!token) return alert("‚ö†Ô∏è Please paste your access token first!");

      if (socket && socket.readyState === WebSocket.OPEN) {
        alert("Already connected!");
        return;
      }

      const protocol = window.location.protocol === "https:" ? "wss" : "ws";
      socket = new WebSocket(`${protocol}://${window.location.host}/ws/chat/${roomId}/?token=${token}`);

      socket.onopen = () => {
        console.log("‚úÖ Connected to chat server");
        appendMessage("System", "‚úÖ Connected to chat!", false);
      };

      socket.onerror = (e) => {
        console.error("‚ùå WebSocket error:", e);
        appendMessage("System", "‚ùå Connection error", false);
      };

      socket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === "connection_established") {
          currentUserId = data.user_id;
          data.messages.forEach((m) =>
            appendMessage(m.sender_full_name, m.content, m.sender_id === currentUserId)
          );
        }
        if (data.type === "chat_message") {
          appendMessage(data.sender_full_name, data.message, data.sender_id === currentUserId);
        }
      };

      socket.onclose = () => appendMessage("System", "‚ùå Disconnected from server", false);
    };

    sendBtn.onclick = () => {
      if (!input.value.trim()) return;
      if (!socket || socket.readyState !== WebSocket.OPEN) {
        alert("Socket not connected!");
        return;
      }
      socket.send(JSON.stringify({ message: input.value }));
      input.value = "";
    };
  </script>
</body>
</html>
